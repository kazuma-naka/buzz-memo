var $="https://buzz-memo.vercel.app/",n=class{constructor(e=$){this.base=e}async _fetch(e,i={}){let t=await fetch(`${this.base}${e}`,{mode:"cors",...i});if(!t.ok)throw new Error(`${e}: ${t.status} ${t.statusText}`);return t.json()}getUserIdByEmail(e){return this._fetch(`/api/getUserId?email=${encodeURIComponent(e)}`)}getServices(e){return this._fetch(`/api/getServices?email=${encodeURIComponent(e)}`)}async isBookmarkSaved(e,i){try{return(await this._fetch("/api/isBookmarkSaved",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,title:i})})).saved===!0}catch{return!1}}insertBookmark(e){return this._fetch("/api/insertBookmark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}};var f=()=>new Promise((r,e)=>{chrome.runtime.sendMessage({type:"getUserProfile"},i=>{i?.profile?r(i.profile):e(new Error(i?.error||"Failed to get profile"))})});var c=r=>r.toString().padStart(2,"0"),w=()=>{let r=new Date;return`${r.getFullYear()}-${c(r.getMonth()+1)}-${c(r.getDate())} ${c(r.getHours())}:${c(r.getMinutes())}:${c(r.getSeconds())}`},o=(r,e=document)=>e.querySelector(r),b=(r="")=>r.replaceAll('"',"&quot;");var p={login:o("#login-section"),user:o("#user-section"),service:o("#service-section"),renderLogin(r){this.user.innerHTML=`<strong>\u30ED\u30B0\u30A4\u30F3:</strong> ${r}`,this.login.innerHTML=""},renderServiceSelect(r){this.service.innerHTML=`
      <select id="service-select" style="width:100%">
        <option value="" disabled>-- \u30B5\u30FC\u30D3\u30B9\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044 --</option>
        ${r.map(({id:e,title:i},t)=>`<option value="${e}" ${t===0?"selected":""}>${i}</option>`).join("")}
      </select>`,this.service.style.marginTop="10px"},renderMetaForm(r,e){let i=document.createElement("div");i.id="meta-form",i.style.marginTop="10px",i.innerHTML=`${t("\u30BF\u30A4\u30C8\u30EB","meta-title",r.title)}
      ${t("\u8AAC\u660E","meta-description",r.description,!0)}
      ${t("URL","meta-url",r.url)}
      ${t("Favicon URL","meta-favicon",r.favicon_url)}
      ${t("Twitter\u753B\u50CFURL","meta-twitter-img",r.twitter_image_url)}
      ${t("\u516C\u958B\u65E5","meta-publish-date",(r.publish_date??"").slice(0,10),!1,"date")}
      <button id="save-btn" style="width:100%;margin-top:10px">\u4FDD\u5B58</button>`,document.body.appendChild(i),o("#save-btn").onclick=e;function t(h,s,d="",u=!1,g="text"){return u?`<label>${h}</label><br><textarea id="${s}" rows="3" style="width:100%">${b(d)}</textarea><br><br>`:`<label>${h}</label><br><input id="${s}" type="${g}" value="${b(d)}" style="width:100%"><br><br>`}}};var l=class{constructor(){this.api=new n,this.userId=null,this.meta=null,this.tabId=null}async init(){try{let{email:e}=await f();p.renderLogin(e),this.userId=(await this.api.getUserIdByEmail(e)).id;let{services:i}=await this.api.getServices(e);p.renderServiceSelect(i),await this.scrapeActiveTab();let t=await this.api.isBookmarkSaved(this.userId,this.meta.title);this.updateIcon(t)}catch(e){console.error("PopupApp init",e),alert("\u521D\u671F\u5316\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u8A73\u7D30\u306F\u30B3\u30F3\u30BD\u30FC\u30EB\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002")}}async scrapeActiveTab(){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||e.url.startsWith("chrome://"))throw new Error("Unsupported page");this.tabId=e.id;let[{result:i}]=await chrome.scripting.executeScript({target:{tabId:this.tabId},func:()=>{let t=(a,m="content")=>{let v=document.querySelector(a);return v?m==="text"?v.textContent.trim():v.getAttribute(m):null},s=[()=>t("meta[property='article:published_time']"),()=>t("meta[property='og:published_time']"),()=>t("meta[itemprop='datePublished']"),()=>t("meta[name='date']"),()=>t("meta[name='pubdate']"),()=>t("meta[name='DC.date.issued']"),()=>t("time[datetime]","datetime"),()=>t("time.published","datetime"),()=>t(".post-date","text"),()=>t(".entry-date","text"),()=>t(".publish-date","text"),()=>t("relative-time","datetime"),()=>document.querySelector(".posted")?.textContent?.match(/\d{4}-\d{2}-\d{2}/)?.[0]??null].map(a=>a()).find(a=>!!a),d=s?new Date(s).toISOString():new Date().toISOString(),u=(a,m="name")=>document.querySelector(`meta[${m}="${a}"]`)?.content,g=document.querySelectorAll('link[rel*="icon"]')[0]?.href;return{title:document.title,description:u("description"),favicon_url:g,twitter_image_url:u("twitter:image"),publish_date:d}}});this.meta={...i,url:e.url},p.renderMetaForm(this.meta,()=>this.saveBookmark())}async saveBookmark(){let e=o("#service-select").value;if(!e)return alert("\u30B5\u30FC\u30D3\u30B9\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044\u3002");let i={title:o("#meta-title").value,description:o("#meta-description").value,url:o("#meta-url").value,favicon_url:o("#meta-favicon").value,twitter_image_url:o("#meta-twitter-img").value,publish_date:o("#meta-publish-date").value||this.meta.publish_date||w(),last_updated_user_id:this.userId,service_id:e};try{await this.api.insertBookmark(i),alert("\u30D6\u30C3\u30AF\u30DE\u30FC\u30AF\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F\u3002"),this.updateIcon(!0),chrome.storage.local.set({[i.url]:!0})}catch(t){console.error("saveBookmark",t),alert(`\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F: ${t.message}`)}}updateIcon(e){chrome.action.setIcon({path:e?"icon-saved.png":"icon-default.png",tabId:this.tabId})}};document.addEventListener("DOMContentLoaded",()=>new l().init());
